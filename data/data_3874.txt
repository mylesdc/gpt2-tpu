We perform inference via Markov chain Monte-Carlo (MCMC) using the Li and Stephens approximation to the coalescent with recombination [1], with one further key approximation. Consider two data sets:
1. D = viral sequences for which host HLA data is also available.
2. D B = viral sequences for which host HLA data is not available.
As D B is very large, we can assume that D B represents the collection of viral sequences (subject to recombination) that a host can be infected with. A large number of sequences in D B results in short coalescence times between any given member of D and D B , increasing our power to estimate parameters. By making this approximation, we may then assume that selection along the lineage joining a given member d of D to its nearest neighbour in D B occurred within the individual from whom the virus d was sampled. We have associated host HLA profiles for D, and so may then estimate HLA-associated selection conditional on this HLA information. A cartoon of this model is shown in Figure 1b .
The Li and Stephens approximation allows us to evaluate the probability that a member of D arises as an imperfect mosaic of sequences in D B using a hidden Markov model (HMM). To model this process, we must specify a recombination model, and model of sequence evolution. We assume that recombination is site dependent, and occurs with probability r i between site i − 1 and i to any other member of D B uniformly at random. We model sequence change using the NY98 codon model [2] (which distinguishes transitions from transversions via the transition/transversion ratio; κ, and nonsynonymous changes from synonymous changes via the dN dS ratio; ω), with some modifications. To incorporate HLA-associated selection for escape, we define a consensus non-escaped strain C for the region to be analysed. A scaling, h∈H γ h,i , dependent on the host's HLA profile, H, then modifies any non-synonymous codon change from this consensus strain. We model reversion in a similar manner: a boost in codon substitution rate towards the consensus codon C at each site, ζ i . Note that reversion only acts on non-synonymous changes toward the consensus codon C , and as such the parameterisation is identifiable. To switch from rates to probabilities we integrate over the length of a lineage connecting a member of D to D B assuming a standard coalescent. For example for a non-synonymous transition from C i to some codon C,
where φ is the empirically estimated probability of observing a single codon change along the lineage joining D to D B , A is the total codon substitution rate out of C i , a i is the number of non-synonymous transitions from C i , k is the number of sequences in D B and π C is the empirical probability of observing C given a ≥ 2 step codon change. We approximate the probability in this manner to avoid computationally expensive matrix exponentiation. Given recombination probabilities and codon transition probabilities for all possible codon changes and the Li and Stephens approximation, we are armed with an HMM to describe an approximation to the process generating members of D. We can therefore use the forwards and backwards algorithms to integrate over all paths through D B to generate each member of D in turn. We then take the product over all members of D to approximate the likelihood:
where H denotes HLA information (across members of D and D B ), H j is the collection of HLA types of the host associated to viral sample D j ∈ D, andπ is the function describing the Li and Stephens approximation with our model of recombination and codon evolution.
Evaluating D j ∈Dπ (D j |D B , H j , Θ) in practice becomes computationally difficult as D B increases in size, as it involves the evaluation of arrays of dimension |D B | × |D| × |codon sequence|. To increase computational efficiency, we restrict D B to a subset D B j for each member of D. In our simulations and analyses we use a simple Hamming distance restriction: the closest n sequences by Hamming distance to define each D B j . Now that we are able to evaluate approximate likelihoods rapidly, we can perform MCMC to obtain posterior distributions for our parameters of interest:
• dN dS at each site, ω i . • HLA-associated selection at each site, γ h,i .
• Recombination probabilities between neighbouring sites, r i .
• Synonymous transversion rate, µ.
We use the Li and Stephens [1] approximation, as it captures many of the properties of the coalescent with recombination in a computationally efficient manner. We describe the approximation and explain our modifications.
Let Θ denote a collection of parameters governing codon substitution and let D = {D 1 , D 2 , . . . , D n } denote a collection of sequences from n samples. The approximation follows from observing that the likelihood P (D 1 , D 2 , . . . , D n |Θ) may be written as a product of conditional likelihoods, each of which is then approximated by a function which we denoteπ. I.e.: P (D 1 , D 2 , . . . , D n |Θ) = P (D 1 |Θ)P (D 2 |D 1 , Θ) . . . P (D n |D 1 , D 2 , . . . , D n−1 , Θ)
(3) ≈π(D 1 |Θ)π(D 2 |D 1 , Θ) . . .π(D n |D 1 , D 2 , . . . , D n−1 , Θ).
The right hand side of (4) is known as the product of approximate conditionals (PAC) likelihood as each conditional likelihood P (D k+1 |D 1 , D 2 , . . . , D k , Θ) is approximated using the functionπ. Li and Stephens [1] use a hidden Markov model (HMM) forπ that captures a collection of desirable properties of the true likelihood function, but is computationally tractable, because that the (k + 1) th sequence is an imperfect mosaic of the first k sequences due to mutation and recombination. For the (k + 1) th sequence, the hidden states are the first k sequences. We denote X 1 , X 2 , . . . , X m as the hidden Markov chain that emits the sequence D k+1 , where X j is the sequence being copied from (SCF) at position j and m is the length of the sequence. Between each site, the SCF switches to a new sequence l with probability q x,i (j) (which may depend on the current SCF; x, the new SCF; i, and the current site; j). Given a hidden state at position j, the probability of observing the codon in the observed sequence D k+1 is generated by a model of codon substitution. To generateπ(D k+1 |D 1 , D 2 , . . . , D k , Θ) we integrate over all possible paths through sequences D 1 , D 2 , . . . , D k that can generate the sequence D k+1 through a combination of jumping between these k sequences (recombination) and error in copying (mutation), as illustrated in Figure 1b .
As the approximation to the process generating sequence D k is an HMM, we can appeal to the forwards and backwards algorithms [3] to evaluateπ(D k+1 |D 1 , D 2 , . . . , D k , Θ) for each k. The forwards algorithm proceeds as follows:
Let D k+1 [1 : j] denote the codons at the first j sites of sequence k +1 and let f i,j denote the probability of observing all codons in D k+1 up to site j − 1 and copying the codon in position j from sequence i.
. Let the probability of copying the codon at position j from sequence i be denoted ε i,j . This is the probability of an observed state given a hidden state, and is known as an emission probability in the language of HMMs. Then f i,1 is just an emission probability and easily computed if we have a uniform prior on the SCF at the first position. We then calculate f i,j for j ≥ 2 recursively as follows:
where, as defined earlier, q x,i (j) is the combined probability of recombination and the destination sequence being sequence i. Note that we make the implicit assumption that recombination events may only occur between codons and not within them. If we assume that all sequences are equally likely to recombine (as in [1] and [4] ) then (5) may be simplified to
where r j is the probability of recombination between the (j − 1) th and j th position.
For the (k + 1) th sequence,π
We may similarly run the backwards algorithm, starting at the last site and evaluating iteratively towards the first site. Let D k
where the last implication is a consequence of the Markov property. The b i,j s for the (k +1) th sequence can then be generated iteratively as follows
Hence we can calculate
Note that the approximation of P (D 1 , D 2 , . . . , D n |Θ) using this HMM is dependent upon the ordering of {D 1 , D 2 , . . . , D k }. This is often resolved by randomly permuting the ordering some fixed number of times and determining an average [4] , or by letting the order be an unknown parameter [5] . Here we remove the ordering issue by considering each query sample independently.
In our inference problem we have two data sets. One query data set; D for which we have associated host HLA information and another larger reference data set; D B without host HLA information. Recall from our model summary that we make two important assumptions:
1. All selection along the lineages connecting a member of D to D B occurred within the host of the member of D.
2. The reference data set D B is a good approximation of the distribution of viruses an individual can be infected with (which is reasonable when |D B | 0).
These two assumptions allow us to apply the Li and Stephens approximation. In the HMM we require emission probabilities. For our model these will be probabilities of codon substitutions in the presence of some HLA profile. Making assumption 1 allows us to approximate P (D|D B , Θ). This is because we have HLA genotype information for the members of D = {D 1 , D 2 , . . . , D n } which we can use to determine the relevant emission probabilities. I.e. The first assumption allows us to use the sequence data in D B :
Using assumption 2, we may write
In other words, assumption 2 results in the approximation that D is generated by independent realisations of recombination and mutation through D B . This avoids any need for averaging over orderings of D, allowing rapid evaluation of the approximate likelihood.
Within the MCMC, we have three main classes of move. Moves to alter a parameter at a single site or window of sites, moves to merge or split windows, and moves to expand and contract selection windows to push them around the genome. When adding HLA-associated selection to our codon model of substitution, we considered separate parameters to scale selection away from consensus in the presence of each host HLA type at each site (γ h,i ), and parameters to model reversion towards consensus at each site (ζ i ). In order to increase speed we alter these parameters within selection windows in our MCMC scheme. The selection windows that we discuss are analogous to the selection windows and recombination windows described in [4] . We now introduce some notation:
Let S := {s 1 , s 2 , . . . , s S } be a collection of sites that split windows, and let |S| = S. We may then alter parameters occurring within selection windows [s k , s k+1 ), s k ∈ S ∪ {1, l} (defining s 0 = 1, s S+1 = l). The number of selection windows is S + 1, and parameters are constant across these windows.
For recombination and selection, the parameters r i and ω i are estimated between each pair of neighbouring sites (i − 1, i), and at each site i respectively. For HLA associated selection and reversion parameter changes, moves are applied to a window of these parameters. Note, for each HLA type h we assign a distinct collection of selection windows.
Selection parameters ω i . We only use a single type of MCMC move to alter ω i across the codon sequence: changing ω i at a given site i. We assume an exponential prior with parameter λ ω for ω i . Following the existing model [4] , a new value ω i is chosen such that ω i = ω i exp(U ), where U ∼ Uniform(−1, 1) and the acceptance probability is
⇒ α ω (Θ → Θ ) = min 1,
Here, L(Θ|D) is the likelihood of Θ given the data, P (x) is the prior on x, and q(x → x ) is the proposal distribution. The MCMC move to alter µ is identical.
A truncated normal, gamma, or uniform prior can also be chosen as a prior for ω i in our program.
Recombination Probabilities r i . Assuming independence between sites, and a distinct recombination rate at each site, we must vary r i for i ∈ {2, 3, . . . , m}, where m is the number of codon sites in the sequence. We do this by perturbing the recombination rate at a given site in exactly the same way as for the selection parameters (ω i ) through a shift on the log scale. The recombination rate is related to the probability of recombination through the relation
where ν i is the recombination rate between sites i − 1 and i, and k is the number of sequences. We allow moves to alter the recombination rate in the same way as the selection parameters, ω i . A new value ν is chosen such that ν = ν exp(U ), where U ∼ Uniform(−1, 1). We have an exponential prior for ν with rate parameter λ ν . The acceptance probability is identical to that of the selection parameters, with ω i and λ ω replaced with ν i and λ ν respectively.
Window Moves. Here, we consider only escape parameters (moves associated to reversion parameters are completely analogous) and for notational convenience we let γ h,i = γ i , and allow i to now enumerate windows rather than sites.
Moves are proposed in the same way as for selection parameters, ω i , but across a window rather than at a specific site. The window is chosen uniformly at random from the current collection of windows. We use a log-normal distribution, log N ∼ (0, σ 2 γ ) for the prior on HLA dependent scaling of selection parameters, and the resulting acceptance ratio is
2. Extension of a window in the 3 or 5 direction
Choose a window to extend uniformly at random, with 5 or 3 direction chosen with equal probability. Choose the number of sites to extend g ∈ [1, ∞) from a geometric distribution. Any proposal that results in a window being merged is rejected, as is the proposal to extend the 5 -most or 3 -most block in the 5 or 3 direction respectively. Otherwise, the acceptance probability is
These final two moves are complementary reversible jump MCMC moves. A site s * is chosen uniformly from the collection of available splitting sites, and with probability 1 splits an existing window, [s i , s i+1 ) say. New HLA dependent selection parameters within these new selection windows [s i , s * ) and [s * , s i+1 ) are defined as γ i 1 and γ i 2 where
It then follows that the acceptance ratio is
6 where c S := min 1, P (S + 1) P (S) and d S := min 1, P (S − 1) P (S) (28) are the probability of proposing a split and merge move respectively when the current number of splitting sites is S.
Merge a window. Pick a splitting site s i+1 , i ∈ {0, 1, . . . , S − 1} at random to remove, resulting in a merge of windows [s i , s i+1 ) and [s i+1 , s i+2 ). Let
and accept with probability
A truncated Normal, Gamma, or uniform prior can also be chosen as a prior for the escape and reversion parameters in our software.
As part of the burn in period during MCMC runs, we perform simulated annealing. This allows us to explore the parameter space as much as possible during these early stages. Doing so is very simple within an MCMC framework. At earlier steps in the MCMC the chain is 'hotter'. This simply means that the likelihood portion of the posterior carries less weight in the posterior and thus flattens the posterior density, allowing for greater exploration of the parameter space. We do this by raising the likelihood ratio to the power T where T > 1. Note that, as T → ∞ we are effectively sampling from the prior. We then let T be a function of the MCMC step t, such that T (t) → 1 as t → ∞. The functional form that we choose is
Note that T (0) = T 0 . We set α = 0.999, and T 0 = 500.
Six methods are applied to the sequence and HLA information simulated under 100 independent birth-death processes (described in the Methods subsection Simulation study 2: A sampled birth death process): 6. Our methodology as described in the Methods section of the main text.
In each case, we assume that the consensus 'wild type' strain is correctly defined and set any nonsynonymous difference from consensus as escape. For methods 2, 4 and 5, we determine a maximum likelihood estimate of the underlying genealogy using RAxML version 8.2.11 [11] . Methods 1, 3 and 6 do not require an estimate of the genealogy. We now briefly summarise each of the compared methods.
Fisher's exact test A simple Fisher's exact test is applied by splitting the query sequences according to the following 2 × 2 contingency 
where λ esc and λ esc , β, c and f HLA are estimates of the population escape and reversion rates, transmission probability, contact rate, and proportion of individuals in the population with the HLA type under investigation. Λ 0 and Λ 1 are the proportion of HLA mismatched hosts with an escape mutant at the investigated site, and proportion of HLA matched hosts with an escape mutant at the investigated site. We note that neither β nor c are required to preserve the ordering of escape and reversion rates, and as such do not affect the associated ROC curves. The ordering is also preserved at the stationary phase [8] . In cases where the resultant escape or reversion rate estimate is negative, we set the escape rate estimate at zero under the assumption that the model does not fit the simulated data.
PhyloD We implement the methods of Carlson et al. as described in [9] . As described above, we determine an estimate of the maximum likelihood tree, G max using RAxML [11] before using likelihood ratio tests to compare models conditional on the maximum likelihood tree. The initial null model at each site is a simple two state model described by two parameters -the mutation rate; λ, and the stationary probability of observing the wild-type amino acid; π. The associated instantaneous rate matrix is
Felsenstein's peeling algorithm [13] is then used to evaluate the likelihood L(λ, π|D, G max ) and maximised, where D is the combination of simulated query sequences and associated host HLA data. So called 'leaf-distributions' are then potentially added using forward selection. This involves the inclusion of further hidden states -estimates of the transmitted sequence for each subsequently sampled member of the query sequences set. This transmitted sequence is then potentially modified conditional on the hosts' HLA. In the case of escape, the probability of an instantaneous switch from wild-type to escape is parameterised by a probability; p. Thus, given Q above for the remainder of the tree, and probabilities of switching between states between the hidden 'transmitted sequence' and the query sequences at the leaves, we can evaluate L(λ, π, p|D, G max ) using tree peeling. Maximising this likelihood and comparing to the current null model, parameters are added if the p-value for the associated likelihood ratio test is lower than 0.05. Whereas in Carlson et al. maximum likelihood parameterisations are obtained by either coordinate descent [14] or expectation-maximisation [9] , we take a pragmatic approach, as often certain optimisation schemes fail under different scenarios. To this end, we simultaneously run six different optimisation schemes built into the optimx R package [15] : Nelder-Mead [16] , L-BFGS-B [17] , ucminf [18] , nmkb [19] , newuoa [20] , bobyqa [21] . We stipulate that at least two schemes must converge, and choose the likelihood parameterisation of the scheme with the highest likelihood. If less than two schemes converge, new starting parameters are chosen at random and estimates are re-evaluated.
PhyloD OR A slight modification of PhyloD, PhyloD OR also involves a simple alteration of the standard peeling algorithm, but instead of a 'leaf-distribution' being added at the leaves, a logistic regression is applied between the hidden transmitted states and the observed sequence data at the leaves -see Carlson et al. for some details [10] . Likelihoods can then be evaluated based on the probabilities associated to this logistic regression fit using a peeling algorithm [13] . E.g. Rearranging
where P is the probability of observing an escape mutation, X i are binary variables taking the value 0 or 1 (for presence/absence of HLA i) depending on the HLA status of the host associated to a given leaf sequence. T is a further binary variable, which takes the value -1 if the state at the hidden transmitted state is wild-type, and 1 if it is escape. Given that these transmitted states are unknown, they are summed over using tree peeling. a i s and c are fitted using maximum likelihood optimisation schemes as for PhyloD. Following Carlson et al. we again use forward selection and likelihood ratio tests and add parameters to the model if p < 0.05.
Using each of the five methods described above, plus our new approach as described in detail in the methods section of the main text, we obtain p-values or parameter estimates which provide a metric for the strength of selection for escape at each site, conditional on each of the HLA types. We use the p-value, p-value, escape rate estimate, probability estimate, strength of selection; a i , and median HLA associated selection parameters; γ h for each of the six methods respectively to determine ROC curves for each of the 100 simulated sequence and host HLA data sets, displayed in Figure 2 of the main text. We also examined the effect of increasing the query sequence set with associated host HLA information to 3000. The resultant ROC curves for each of the five methods are shown in Supplementary Figure  7 .
To examine the impact of a reduced reference data set D B upon parameter estimates, we subset to 100%, 10% and 1% of the reference sets in Simulation Study 2. We then performed inference and determined the impact of a smaller D B on the accuracy of our results. ROC curves for our method with different reference data sets sizes are shown in Supplementary Figure 8 .
Drug associated selection analysis
All sequences and their associated host drug regime data were downloaded from the Stanford drug resistance database [22] . We used the alignments provided, though sites at which there was ≥5% ambiguity were removed, followed by sequences for which there was ≥5% nucleotide ambiguity across the region of interest. In reverse transcriptase a ∼550 nucleotide region is sequenced much more frequently than the remainder of the gene and we wish to retain power to estimate parameters. One sequence per patient was included in the combined alignment of reference and query data sets by removing repeat entries of any given patient identifier uniformly at random (assuming unique patient identifiers ⇒ unique patients).
The data set was then split in two, sequences for which the host was not receiving any drugs D B , and sequences for which the host was receiving drugs D. 1,000 sequences were then randomly chosen from D B and placed in D. As described in the text, this step was included to guarantee variation within the query data set in drug associated selection. D B defines our reference data set. We perform some further data cleaning steps to create the query data set from D.
Sequences were removed from D if RTI, NNRTI, NRTI or PI was used as a descriptor of one of the drugs in a patients drug regime, as this was not specific enough for our purposes. Finally, any sequences which were associated to a drug present in D fewer than 10 times were removed. Drug information associated to the query sequences was reformatted into a .csv file with binary entries so that it could be read by our program.
The resulting collections of reference and query data sets consisted of 49,721 reference sequences and 6,130 query sequences with associated drug regime data for the protease data set, and 54,663 and 13,885 query sequences with associated drug regime data for the reverse transcriptase data set.
To investigate HLA-associated selection was more cumbersome, we wished to incorporate as much data as was publicly available into our analyses. To achieve this, we focused on the most highly sequenced portions of the viral genome: protease and reverse transcriptase. To create the reference data sets we concentrated on three major sequence resources:
1. Los Alamos HIV sequence database.
2. Stanford Drug resistance database.
3. UCLA HIV positive selection mutation database.
Before filtering, the combination of these three databases represented a total of 119, 878 + 81, 533 + 45, 161 = 246, 572 and 148, 866 + 88, 780 + 45, 161 = 282, 807 sequences in protease and reverse transcriptase respectively. For the Los Alamos HIV sequence database portion of the reverse transcriptase reference data set, we allow sequence chunks of length >500 nucleotides.
To create the query data sets, we combined viral sequence data with associated host HLA information from the following sources (see also Table 1 in the main text):
• Swiss Spanish intermittent treatment trial (SSITT) data set [23, 24] : Swiss portion of this data set.
• Durban data set [25, 26] .
• Mma Bana (mother and child) study [27] : adult portion of this study.
• Bloemfontein data set [28, 29] .
• The short pulse antiretroviral therapy at seroconversion (SPARTAC) data set [30] : UK portion of this data set.
• All remaining sequences with associated host HLA data available in the Los Alamos HIV sequence database [31] which were not present in the above studies.
In order to arrive at the final collection of reference and query sequences combined with HLA information we applied a number of filtering steps.
Creating the reference sequence data set.
1. Remove overlap between the Stanford drug resistance database and Los Alamos HIV sequence database: for any patient identifiers present in both databases, we remove all sequences corresponding to that patient from the Los Alamos database sequences.
2. Remove sequences with associated host HLA information from both the Stanford drug resistance database and Los Alamos HIV sequence database sequences: this was achieved by comparing patient identifiers. The appropriate sequences were removed from the Stanford drug resistance database and Los Alamos HIV sequence database sequences.
3. Remove repeat patient entries: again, this was achieved using patient identifiers. For any repeated patient identifier, one sequence was kept (chosen uniformly at random from among the sequences with the same patient identifier).
We next aligned the collection of sequences; a non-trivial task given the vast amount of sequence data. The alignment of protease in the Stanford drug resistance database is well maintained, so we assumed that this portion of the alignment is accurate. Note that this is why we remove the Los Alamos database copy where there is overlap between the Stanford drug resistance database and Los Alamos sequence databases. In the case of the sequences taken from the Los Alamos HIV sequence database, we find that attempting to generate an alignment when downloading ∼70,000 sequences yields nonsensensical results. However, there is a lack of indels in the protease region. We therefore simply considered sequences of exactly 297 nucleotides for the alignment (after removal of gaps from the alignment proposed using the Los Alamos database default alignment software). Performing this step led to a loss of <500 sequences out of a total of ∼70,000. We then checked the resulting distribution of nucleotides across the region. Finally, the UCLA positive selection database was assumed to be aligned correctly.
Such a simple alignment procedure was not available to us for the reverse transcriptase sequences due to the increased prevalence of indels within reverse transcriptase, coupled with the longer sequence length. We reduced the size of the collection of sequences to be aligned by assuming sequences taken from the Stanford drug resistance database were correctly aligned. Aligning all the remaining sequences at once using MUSCLE [32] was prohibitive computationally, as was using the align option in MUSCLE (which can be used to combine alignments: this procedure also tended to produce artefacts in the overall alignment). We therefore considered the approach of aligning subsets of 5000 sequences and comparing these sub-alignments. We found that although more common than within protease, indels are rare. Removing them resulted in a collection of sub-alignments that aligned with both each other and the consensus sequences for both the Stanford drug resistance database and UCLA positive selection database alignments.
We removed ambiguous codons and sequences from both the protease and reverse transcriptase alignments by first deleting codons with > 5% ambiguity and then sequences with > 5% sequence ambiguity as in our data set prepartion for the drug associated selection analysis. Removal of sequence ambiguity resulted in a total of 162, 901 and 184, 817 reference sequences for protease and reverse transcriptase respectively.
Creating the query data set
As in the reference sequence filtering step, we remove repeat patient entries using patient identifiers: For any repeated patient identifier, one sequence was kept (chosen uniformly at random from among the sequences with the same patient identifier).
We aligned the query sequences using MUSCLE [32] . We found that no gaps were introduced (aside from at the beginning and end of the sequences). Both the protease and reverse transcriptase query sequences align with their respective reference sequence data sets.
We checked ambiguity of codons and sequences within the query data sets using the same criteria as in our reference data set preparation, removing codon positions and sequences as required.
Throughout, HLA typing was restricted to two digits and HLA-A, B, and C alleles were analysed jointly. We truncated to two-digits in the interests of power: although the most common 4 digit HLAs could be considered separately, the majority are rare at 4 digit resolution in our data set (60.5% of 4-digit HLAs have a count of < 10, compared to 30.2% at 2-digit resolution). Moreover, 27.3% of the individuals were only typed at 2-digit resolution. However, this should be feasible in the future as sample sizes of viral sequence data with associated host HLA types increase.
In both the query and reference data sets after filtering we obtain a relatively constant sequence ambiguity across the newly defined regions of protease and reverse transcriptase, with slight increases at the start and end of the region as we would expect. Consensus nucleotide proportion across both newly defined regions averaged across all sites is 0.941 and 0.943 for protease and reverse transcriptase respectively, with any large drop below this coinciding with a subtype B/C consensus sequence difference at the nucleotide level.
The resulting cleaned data sets consist of:
• A reference data set D B consisting of sequences taken from Los Alamos sequence database, the Stanford Drug resistance database and the UCLA positive selection database for which no host HLA information was available.
• A query data set which consists of:
1. Viral sequence data D.
2. Host 2 digit HLA genotype data H for the three HLA class I alleles associated to the viral sequences in D.
We determine whether HLA alleles with similar sequences, or drug with similar modes of action lead to selection responses that are similar. To obtain dendrograms of drug selection profiles and HLA selection profiles we first assign estimated per-site selection coefficients to one of four broad classes, based on the median of the selection profile at that site:
We avoid considering lower quantiles due to potential biases which would be induced by drug/HLA specific sample sizes. We then perform hierarchical clustering on assigned selection classes using hclust (in the R stats library), using the complete linkage method. The resultant dendrograms for drug associated selection are shown in Supplementary Figure 13 .
We compare the topology of dendrograms obtained from HLA selection profiles to dendrograms obtained from human HLA protein sequence information from the IMGT database [33] . To obtain a dendrogram based on host HLA sequence information for comparison, we first remove identical HLA protein sequences in the available sequenced region and restrict analysis to the first four members of each 2-digit HLA type for which we have estimated an HLA selection profile for HIV-1. We use RaxML [11] to obtain maximum likelihood trees for each of the three class I molecules. As we expect, members of the same 2-digit HLA type cluster together.
To compare dendrogram topologies, we determine the number of 2-digit HLA types which share closest neighbours (closest leaf within the dendrogram) across the 2 dendrogram topologies. As a permutation test, we shuffle tip labellings to obtain a distribution on this metric. As HLA alleles with the same first two digits lie at slightly different positions in the host HLA protein dendrogram, we randomly restrict to one representative of each 2-digit HLA 100 times, and perform 10,000 label shuffles for each of these restrictions to obtain the distribution for our nearest neighbour metric. From this distribution, we calculate p-values and odds ratios.
Derivation of expected divergence time to closest relative in a coalescent tree with k leaves Consider adding a new lineage to an existing tree with k lineages. We are interested in the the distribution of the time, t, at which it first coalesces with an ancestral lineage within the existing genealogy. To derive the mean, let T k be the total tree length of a coalescent tree with k lineages. Then,
Thus, since t = T k+1 − T k ,
To approximate the distribution of the time to coalescence between a lineage and the rest of the tree, we use an exponential distribution with parameter k 2 .
We compare inference within our study (summarised in Figure 5b) to previous results at a series of well-studied epitopes. Putative CTL escape sites within HLA-B associated A-list epitopes are highlighted in yellow. Notice that many A-list epitopes are not variable.
B * 07 epitope SPAIFQSSM (sites 156-164 in reverse transcriptase). We detect strong B * 07-dependent selection at the known escape site (position 162) [34, 35] . We also find two more top-tier sites and several second-tier sites within the epitope. On further investigation of the literature we find that many variants exist for this epitope, which result in non-susceptible forms in some individuals and susceptible forms in others [36] .
B * 18 epitope NETPGIRYQY (sites 137-146 in reverse transcriptase). We detect strong B * 18-dependent selection at the first anchor residue of NETPGIRYQY (site 138) [35, 37] . We do not detect selection at the other escape site. Further investigation of the literature reveals that the 'diminished response' induced by a variant at this site is actually recognised to much the same levels as the wild type epitope, and precedes outgrowth of the single variant at the first anchor residue in the single patient studied [38] . Moving on to protease in Supplementary Figure 15 , we detect a strong signal of selection within the B * 44 epitope EEMNLPGRW. This signal is particularly strong at the first anchor residue (site 35) where escape is known to occur [39, 40] .
We now consider well-studied HLA-A epitopes, again starting with reverse transcriptase. See Supplementary Figures 17 (note there are no HLA-C epitopes in our well-studied list):
A * 02 epitope YTAFTIPSV (sites 127-135 in reverse transcriptase). We do not detect A * 02-associated selection in YTAFTIPSV. The subtype B and C consensus residue at the escape site (position 135) is the defined escape allele [41] , explaining why we do not detect a signal. However, we notice that a signal at the escape site is picked up when considering subtype B viruses (see the fifth and sixth A * 02 strips of Supplementary Figure 17 ). This suggests that other mutations at the same residue can also result in a diminished CTL response.
A * 03 epitope AIFQSSMTK (sites 158-166 in reverse transcriptase).
Escape is known to occur at the second anchor residue (site 166) [42, 43] . This site is in our collection of second tier candidates, see Supplementary Figure 17 , with much of the signal coming from the subtype C viruses. However, we do not detect any A * 03-associated selection elsewhere in the epitope.
A * 11 epitope AIFQSSMTK (sites 158-166 in reverse transcriptase).
We do not detect A * 11 dependent selection in this epitope. A * 11 is a relatively rare HLA allele in our query data set.
A * 02 epitope LVGPTPVNI (sites 76-84 in protease).
Finally, looking at Supplementary Figure 14 we see that A * 02-dependent selection is detected in LVGPTPVNI, but not at the reported escape site. We detect strong selection at the first anchor residue, and slightly upstream of the epitope. Interestingly, some literature suggests that the wild type sequence is not recognised, and a drug induced mutation at the escape site (position 82) results in epitope recognition [44] . These conflicting signals may explain why we do not detect A * 02-associated selection at the known escape site.
These findings demonstrate the ability of our method to accurately identify many sites known to be under HLA associated selection, and highlight the nuanced effects of many putative escape variants. N (0, 4) . µ was set at 40, and κ was set at 7.60. The recombination probability between sites, r i , was set at a constant across the region, which we varied between collections of runs (r ∈ {0, 0.01, 0.05}). Figure 5 : Simulation Study 1: comparison of estimates obtained using the closest 100 sequences by Hamming distance to the sequences actually copied from in the simulation, r = 0.05. Averages are taken over 100 independent MCMC runs on independent simulated data with the same underlying parameters. Plotting for the first three rows is as in Figure 3 . The first row shows inference results for HLA 3 associated selection and reversion using sequences copied from in the restriction of D B , the second row shows the corresponding inference results when restricting D B is restricted using the closest 100 sequences by Hamming distance. The third row displays the coverage using the different restrictions. The final two rows display recombination estimates, and an example of inference of ω across the region for the restriction using the sequences copied from and the closest 100 by Hamming distance respectively. Source data are provided as a Source Data file. 1) . For Fryer Approx this is because we stop our threshold for estimated rates at 0. For PhyloD and PhyloD OR, it is because many sites will not be included in leaf distribution or logistic regression respectively. Source data are provided as a Source Data file. (1, 1) . For Fryer Approx this is because we stop our threshold for estimated rates at 0. For PhyloD and PhyloD OR, it is because many sites will not be included in leaf distribution or logistic regression respectively. Pink to red lines and dashed lines show the ROC curves for our approach, using different D B . From light to dark, we sampled 100%, 10% and 1% of D B from each independent run in Simulation Study 2 and estimated HLA-associated selection. Dashed lines of the same colour also include D in D B using a leave one out approach. The black ROC curve shows the results of considering only D using a leave one out approach. Source data are provided as a Source Data file. Grey and white bands display the 5% -95% and 25% -75% credible intervals. In the third row, we display the coverage for the 95% and 50% credible intervals in blue and black respectively. The solid lines are using the gold standard reference set, and the dotted lines are using reference data from all public databases. In each of the fourth rows we display the average RMSE at each site for different D B as defined in the key. Source data are provided as a Source Data file. Grey and white bands display the 5% -95% and 25% -75% credible intervals. In the third row, we display the coverage for the 95% and 50% credible intervals in blue and black respectively. The solid lines are using the gold standard reference set, and the dotted lines are using reference data from all public databases. In each of the fourth rows we display the average RMSE at each site for different D B as defined in the key. Source data are provided as a Source Data file. Grey and white bands display the 5% -95% and 25% -75% credible intervals. In the third row, we display the coverage for the 95% and 50% credible intervals in blue and black respectively. The solid lines are using the gold standard reference set, and the dotted lines are using reference data from all public databases. In each of the fourth rows we display the average RMSE at each site for different D B as defined in the key. Source data are provided as a Source Data file. We display a summary of all the results of each of our MCMC runs applied to protease. Inference results on the grey horizontal strips are coloured as shown in the key. Two grey strips per HLA show selection away from C = B and C = C respectively. Bar plots to the right show HLA frequencies. The two lowest strips summarise median ω according to the colour bar. Blue vertical lines denote drug resistance sites. Green vertical lines denote sites at which there is an amino acid difference between the subtype B and subtype C consensus viral sequence. Colouring of epitopes plotted above the grey lines refers to the A-list [45] and B-list [46] which are coloured purple and pink respectively. In addition, we colour sites of known escape variants within the A-list epitopes in yellow. Figure 15 : Summary of HLA-B associated selection in protease. We display a summary of all the results of each of our MCMC runs applied to protease. Inference results on the grey horizontal strips are coloured as shown in the key. Two grey strips per HLA show selection away from C = B and C = C respectively. Bar plots to the right show HLA frequencies. The two lowest strips summarise median ω according to the colour bar. Blue vertical lines denote drug resistance sites. Green vertical lines denote sites at which there is an amino acid difference between the subtype B and subtype C consensus viral sequence. Colouring of epitopes plotted above the grey lines refers to the A-list [45] and B-list [46] which are coloured purple and pink respectively. In addition, we colour sites of known escape variants within the A-list epitopes in yellow. Source data are provided as a Source Data file. Figure 16 : Summary of HLA-C associated selection in protease. We display a summary of all the results of each of our MCMC runs applied to protease. Inference results on the grey horizontal strips are coloured as shown in the key. Two grey strips per HLA show selection away from C = B and C = C respectively. Bar plots to the right show HLA frequencies. The two lowest strips summarise median ω according to the colour bar. Blue vertical lines denote drug resistance sites. Green vertical lines denote sites at which there is an amino acid difference between the subtype B and subtype C consensus viral sequence. Colouring of epitopes plotted above the grey lines refers to the A-list [45] and B-list [46] which are coloured purple and pink respectively. In addition, we colour sites of known escape variants within the A-list epitopes in yellow. Source data are provided as a Source Data file. Figure 17 : Summary of HLA-A associated selection in reverse transcriptase. We display a summary of all the results of each of our MCMC runs applied to protease. Inference results on the grey horizontal strips are coloured as shown in the key. Two grey strips per HLA show selection away from C = B and C = C respectively. Bar plots to the right show HLA frequencies. The two lowest strips summarise median ω according to the colour bar. Blue vertical lines denote drug resistance sites. Green vertical lines denote sites at which there is an amino acid difference between the subtype B and subtype C consensus viral sequence. Colouring of epitopes plotted above the grey lines refers to the A-list [45] and B-list [46] which are coloured purple and pink respectively. In addition, we colour sites of known escape variants within the A-list epitopes in yellow. Source data are provided as a Source Data file. Figure 18 : Summary of HLA-C associated selection in reverse transcriptase. We display a summary of all the results of each of our MCMC runs applied to protease. Inference results on the grey horizontal strips are coloured as shown in the key. Two grey strips per HLA show selection away from C = B and C = C respectively. Bar plots to the right show HLA frequencies. The two lowest strips summarise median ω according to the colour bar. Blue vertical lines denote drug resistance sites. Green vertical lines denote sites at which there is an amino acid difference between the subtype B and subtype C consensus viral sequence. Colouring of epitopes plotted above the grey lines refers to the A-list [45] and B-list [46] which are coloured purple and pink respectively. In addition, we colour sites of known escape variants within the A-list epitopes in yellow. Source data are provided as a Source Data file. Figure 19 : Estimated recombination probabilities between sites across protease and reverse transcriptase. The mean estimate is plotted in black, the median is plotted in red. The white band denotes the 50% credible interval within the 95% credible interval denoted by the grey band. Blue vertical lines denote drug resistance sites. Green vertical lines denote sites at which there is an amino acid difference between the subtype B and subtype C consensus viral sequence. Source data are provided as a Source Data file. The impact of HLA alleles on differentiation between HIV-1 subtypes. Let C B and C B be the subtype B and subtype C viral sequence consensus respectively. Let H B and H C be the distribution of HLA types in individuals harbouring subtype B and subtype C viruses as defined by RIP [47] in the query data set. The panels display comparisons of HLA-associated selection pressure away from C B and C C by H B and H C . The first row shows results for protease, and the second row shows results for reverse transcriptase. Sites that distinguish subtype B and subtype C at the amino acid level are highlighted in red. Source data are provided as a Source Data file.
Parameter Prior Selection due to H B > H C C C p = 0.70 p = 0.0058 Table 9 : Summary of reference data sets for simulation study 3. Source data are provided as a Source Data file.